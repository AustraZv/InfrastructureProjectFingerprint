/* version: 1.2.0 */(()=>{"use strict";var e=function(){function e(e,t,n,o,r){void 0===o&&(o=Date.now),void 0===r&&(r=3e5),this.token=e,this.sessionId=t,this.expiry=n,this.getNow=o,this.expiryBuffer=r}return Object.defineProperty(e.prototype,"isValid",{get:function(){var e=this.expiry-this.expiryBuffer;return this.getNow()<e},enumerable:!1,configurable:!0}),e.fromToken=function(t){var n=t.split(".")[1];if(!n)throw new Error('Malformed JWT: "'.concat(t,'"'));var o=atob(n),r=JSON.parse(o);if("number"!=typeof r.exp)throw new Error('JWT payload has no expiry (exp): "'.concat(r,'"'));if("string"!=typeof r.sub)throw new Error('JWT payload has no session ID (sub): "'.concat(r,'"'));var i=1e3*r.exp;return new e(t,r.sub,i)},e.fromLocalStorage=function(t){var n=JSON.parse(t),o=n.token,r=n.expiry,i=n.sessionId;if("string"!=typeof o||"string"!=typeof i||"number"!=typeof r)throw new Error("Malformed: ".concat(t));return new e(o,i,r)},e.prototype.toLocalStorage=function(){var e=this,t=e.token,n=e.expiry,o=e.sessionId;return JSON.stringify({version:"v1",sessionId:o,token:t,expiry:n})},e}(),t="".concat("dmg-cross-domain:","session"),n=function(){function n(){}return n.prototype.deleteToken=function(){console.log("Deleting token"),localStorage.removeItem(t)},n.prototype.read=function(){var n,o=localStorage.getItem(t);if(!o)return null;try{n=e.fromLocalStorage(o)}catch(e){return console.log("Safely caught error: ",e),this.deleteToken(),null}return n.isValid?n:(console.log("Session expired"),this.deleteToken(),null)},n.prototype.write=function(e){localStorage.setItem(t,e.toLocalStorage())},n}();const o=/\{[^{}]+\}/g;function r(e,t,n){if(null==t)return"";if("object"==typeof t)throw new Error("Deeply-nested arrays/objects arenâ€™t supported. Provide your own `querySerializer()` to handle these.");return`${e}=${!0===n?.allowReserved?t:encodeURIComponent(t)}`}function i(e,t,n){if(!t||"object"!=typeof t)return"";const o=[],i={simple:",",label:".",matrix:";"}[n.style]||"&";if("deepObject"!==n.style&&!1===n.explode){for(const e in t)o.push(e,!0===n.allowReserved?t[e]:encodeURIComponent(t[e]));const r=o.join(",");switch(n.style){case"form":return`${e}=${r}`;case"label":return`.${r}`;case"matrix":return`;${e}=${r}`;default:return r}}for(const i in t){const s="deepObject"===n.style?`${e}[${i}]`:i;o.push(r(s,t[i],n))}const s=o.join(i);return"label"===n.style||"matrix"===n.style?`${i}${s}`:s}function s(e,t,n){if(!Array.isArray(t))return"";if(!1===n.explode){const o={form:",",spaceDelimited:"%20",pipeDelimited:"|"}[n.style]||",",r=(!0===n.allowReserved?t:t.map(e=>encodeURIComponent(e))).join(o);switch(n.style){case"simple":return r;case"label":return`.${r}`;case"matrix":return`;${e}=${r}`;default:return`${e}=${r}`}}const o={simple:",",label:".",matrix:";"}[n.style]||"&",i=[];for(const o of t)"simple"===n.style||"label"===n.style?i.push(!0===n.allowReserved?o:encodeURIComponent(o)):i.push(r(e,o,n));return"label"===n.style||"matrix"===n.style?`${o}${i.join(o)}`:i.join(o)}function a(e){return function(t){const n=[];if(t&&"object"==typeof t)for(const o in t){const a=t[o];if(null!=a)if(Array.isArray(a)){if(0===a.length)continue;n.push(s(o,a,{style:"form",explode:!0,...e?.array,allowReserved:e?.allowReserved||!1}))}else"object"!=typeof a?n.push(r(o,a,e)):n.push(i(o,a,{style:"deepObject",explode:!0,...e?.object,allowReserved:e?.allowReserved||!1}))}return n.join("&")}}function c(e,t){return e instanceof FormData?e:t&&"application/x-www-form-urlencoded"===(t.get instanceof Function?t.get("Content-Type")??t.get("content-type"):t["Content-Type"]??t["content-type"])?new URLSearchParams(e).toString():JSON.stringify(e)}function u(...e){const t=new Headers;for(const n of e){if(!n||"object"!=typeof n)continue;const e=n instanceof Headers?n.entries():Object.entries(n);for(const[n,o]of e)if(null===o)t.delete(n);else if(Array.isArray(o))for(const e of o)t.append(n,e);else void 0!==o&&t.set(n,o)}return t}function l(e){return e.endsWith("/")?e.substring(0,e.length-1):e}var f,p,h=function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})},d=function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,o=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){i.label=a[1];break}if(6===a[0]&&i.label<r[1]){i.label=r[1],r=a;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(a);break}r[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},y=function(){function e(e){this.apiOrigin=e,this.client=function(e){let{baseUrl:t="",Request:n=globalThis.Request,fetch:f=globalThis.fetch,querySerializer:p,bodySerializer:h,headers:d,requestInitExt:y,...b}={...e};y="object"==typeof process&&Number.parseInt(process?.versions?.node?.substring(0,2))>=18&&process.versions.undici?y:void 0,t=l(t);const g=[];async function m(e,m){const{baseUrl:w,fetch:v=f,Request:S=n,headers:k,params:T={},parseAs:x="json",querySerializer:A,bodySerializer:E=h??c,body:R,...j}=m||{};let C=t;w&&(C=l(w)??t);let O="function"==typeof p?p:a(p);A&&(O="function"==typeof A?A:a({..."object"==typeof p?p:{},...A}));const I=void 0===R?void 0:E(R,u(d,k,T.header)),P=u(void 0===I||I instanceof FormData?{}:{"Content-Type":"application/json"},d,k,T.header),D={redirect:"follow",...b,...j,body:I,headers:P};let U,q,$,L=new n(function(e,t){let n=`${t.baseUrl}${e}`;t.params?.path&&(n=function(e,t){let n=e;for(const a of e.match(o)??[]){let e=a.substring(1,a.length-1),o=!1,c="simple";if(e.endsWith("*")&&(o=!0,e=e.substring(0,e.length-1)),e.startsWith(".")?(c="label",e=e.substring(1)):e.startsWith(";")&&(c="matrix",e=e.substring(1)),!t||void 0===t[e]||null===t[e])continue;const u=t[e];n=Array.isArray(u)?n.replace(a,s(e,u,{style:c,explode:o})):"object"!=typeof u?"matrix"!==c?n.replace(a,"label"===c?`.${encodeURIComponent(u)}`:encodeURIComponent(u)):n.replace(a,`;${r(e,u)}`):n.replace(a,i(e,u,{style:c,explode:o}))}return n}(n,t.params.path));let a=t.querySerializer(t.params.query??{});return a.startsWith("?")&&(a=a.substring(1)),a&&(n+=`?${a}`),n}(e,{baseUrl:C,params:T,querySerializer:O}),D);for(const e in j)e in L||(L[e]=j[e]);if(g.length){U=Math.random().toString(36).slice(2,11),q=Object.freeze({baseUrl:C,fetch:v,parseAs:x,querySerializer:O,bodySerializer:E});for(const t of g)if(t&&"object"==typeof t&&"function"==typeof t.onRequest){const o=await t.onRequest({request:L,schemaPath:e,params:T,options:q,id:U});if(o){if(!(o instanceof n)){if(o instanceof Response){$=o;break}throw new Error("onRequest: must return new Request() or Response() when modifying the request")}L=o}}}if(!$){try{$=await v(L,y)}catch(_){let t=_;if(g.length)for(let n=g.length-1;n>=0;n--){const o=g[n];if(o&&"object"==typeof o&&"function"==typeof o.onError){const n=await o.onError({request:L,error:t,schemaPath:e,params:T,options:q,id:U});if(n){if(n instanceof Response){t=void 0,$=n;break}if(n instanceof Error){t=n;continue}throw new Error("onError: must return new Response() or instance of Error")}}}if(t)throw t}if(g.length)for(let t=g.length-1;t>=0;t--){const n=g[t];if(n&&"object"==typeof n&&"function"==typeof n.onResponse){const t=await n.onResponse({request:L,response:$,schemaPath:e,params:T,options:q,id:U});if(t){if(!(t instanceof Response))throw new Error("onResponse: must return new Response() when modifying the response");$=t}}}}if(204===$.status||"HEAD"===L.method||"0"===$.headers.get("Content-Length"))return $.ok?{data:void 0,response:$}:{error:void 0,response:$};if($.ok)return"stream"===x?{data:$.body,response:$}:{data:await $[x](),response:$};let _=await $.text();try{_=JSON.parse(_)}catch{}return{error:_,response:$}}return{request:(e,t,n)=>m(t,{...n,method:e.toUpperCase()}),GET:(e,t)=>m(e,{...t,method:"GET"}),PUT:(e,t)=>m(e,{...t,method:"PUT"}),POST:(e,t)=>m(e,{...t,method:"POST"}),DELETE:(e,t)=>m(e,{...t,method:"DELETE"}),OPTIONS:(e,t)=>m(e,{...t,method:"OPTIONS"}),HEAD:(e,t)=>m(e,{...t,method:"HEAD"}),PATCH:(e,t)=>m(e,{...t,method:"PATCH"}),TRACE:(e,t)=>m(e,{...t,method:"TRACE"}),use(...e){for(const t of e)if(t){if("object"!=typeof t||!("onRequest"in t||"onResponse"in t||"onError"in t))throw new Error("Middleware must be an object with one of `onRequest()`, `onResponse() or `onError()`");g.push(t)}},eject(...e){for(const t of e){const e=g.indexOf(t);-1!==e&&g.splice(e,1)}}}}({baseUrl:this.apiOrigin})}return e.prototype.getData=function(e){if(e.data)return e.data;throw e.error},e.prototype.fetchSession=function(e){return h(this,void 0,void 0,function(){var t=this;return d(this,function(n){return[2,this.client.GET("/api/session/{sessionToken}",{params:{path:{sessionToken:e}}}).then(function(e){return t.getData(e)})]})})},e.prototype.postSession=function(e){return h(this,void 0,void 0,function(){var t=this;return d(this,function(n){return[2,this.client.POST("/api/session",{body:e}).then(function(e){return t.getData(e)}).then(function(e){return e.token})]})})},e.prototype.patchSession=function(e,t){return h(this,arguments,void 0,function(e,t,n){var o=this;return void 0===n&&(n=[]),d(this,function(r){return[2,this.client.PATCH("/api/session/{sessionToken}",{params:{path:{sessionToken:e}},body:{set:t,remove:n}}).then(function(e){return o.getData(e)}).then(function(e){return e.token})]})})},e}(),b=function(){function e(e){this.base=e,this.fetchCache=new Map}return e.prototype.fetchSession=function(e){var t=this,n=this.fetchCache.get(e);if(n)return console.log('Using cached fetch for session "'.concat(e,'"')),n;console.log('Cached empty. Fetching from API for session "'.concat(e,'"'));var o=this.base.fetchSession(e).finally(function(){t.fetchCache.delete(e)});return this.fetchCache.set(e,o),o},e.prototype.postSession=function(e){return this.base.postSession(e)},e.prototype.patchSession=function(e,t,n){return this.base.patchSession(e,t,n)},e}(),g=function(){function e(e,t){this.sessionParam=e,this.domainAllowList=t}return e.prototype.shouldAnnotate=function(e){try{var t=new URL(e).hostname;return this.domainAllowList.includes(t)}catch(t){return console.debug('Safely caught error for href "'.concat(e,'". Error: '),t),!1}},e.prototype.annotate=function(e,t){var n=new URL(e),o=new URLSearchParams(n.searchParams);return o.set(this.sessionParam,t),n.search=o.toString(),n.toString()},e.prototype.annotateLinksWithSessionToken=function(e){return t=this,n=void 0,r=function(){var t=this;return function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,o=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){i.label=a[1];break}if(6===a[0]&&i.label<r[1]){i.label=r[1],r=a;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(a);break}r[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}(this,function(n){return[2,new Promise(function(n){var o;0===t.domainAllowList.length?(console.log("Empty domain allow list. Skip annotation."),n()):(o=function(){document.querySelectorAll("a").forEach(function(n){var o=n.getAttribute("href");o&&t.shouldAnnotate(o)&&n.setAttribute("href",t.annotate(o,e))}),n()},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o())})]})},new((o=void 0)||(o=Promise))(function(e,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(s,a)}c((r=r.apply(t,n||[])).next())});var t,n,o,r},e}(),m=function(){function e(e,t,n){this.item=e,this.createdAt=t,this.expireAt=n}return e.create=function(t,n,o){void 0===o&&(o=new Date);var r=new Date(o.getTime()+n);return new e(t,o,r)},e.prototype.isValid=function(e){return void 0===e&&(e=new Date),e.getTime()<this.expireAt.getTime()},e.prototype.getValue=function(e){return void 0===e&&(e=new Date),this.isValid(e)?this.item:null},e}(),w=function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})},v=function(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,o=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){i.label=a[1];break}if(6===a[0]&&i.label<r[1]){i.label=r[1],r=a;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(a);break}r[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},S=function(){function t(e){void 0===e&&(e=new n),this.tokenManager=e,this.sessionCache=new Map,this._isConfigured=!1}return Object.defineProperty(t.prototype,"config",{get:function(){if(!this._config)throw new Error("Need to call configure() first!");return this._config},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"apiService",{get:function(){if(!this._apiService){var e=new y(this.config.apiOrigin);this._apiService=new b(e)}return this._apiService},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"linkAnnotator",{get:function(){if(!this._linkAnnotator){var e=this.config,t=e.sessionParam,n=e.domainAllowList;this._linkAnnotator=new g(t,n)}return this._linkAnnotator},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isConfigured",{get:function(){return this._isConfigured},enumerable:!1,configurable:!0}),t.getInstance=function(){return t.singleton||(t.singleton=new t),t.singleton},t.prototype.readToken=function(){return this.tokenManager.read()},t.prototype.writeToken=function(t){return w(this,void 0,void 0,function(){var n;return v(this,function(o){switch(o.label){case 0:return(n=e.fromToken(t)).isValid?(this.tokenManager.write(n),[4,this.linkAnnotator.annotateLinksWithSessionToken(t)]):[3,2];case 1:o.sent(),o.label=2;case 2:return[2]}})})},t.prototype.getUrlSessionToken=function(){return new URLSearchParams(window.location.search).get(this.config.sessionParam)},t.prototype.configure=function(e){return w(this,void 0,void 0,function(){var t,n;return v(this,function(o){switch(o.label){case 0:return this._config=e,(t=this.getUrlSessionToken())?[4,this.writeToken(t)]:[3,2];case 1:return o.sent(),[3,4];case 2:return(n=this.readToken())?[4,this.linkAnnotator.annotateLinksWithSessionToken(n.token)]:[3,4];case 3:o.sent(),o.label=4;case 4:return this._isConfigured=!0,document.dispatchEvent(new CustomEvent("@dmg-cross-domain/configuration-completed")),[2]}})})},t.prototype.getSession=function(e){return w(this,void 0,void 0,function(){var t,n,o,r,i=this;return v(this,function(s){return(t=null===(o=this.readToken())||void 0===o?void 0:o.token)?(n=e&&(null===(r=this.sessionCache.get(t))||void 0===r?void 0:r.getValue()))?[2,n]:[2,this.apiService.fetchSession(t).then(function(e){return i.sessionCache.set(t,m.create(e,3e5)),e})]:[2,null]})})},t.prototype.addAttributes=function(t){return w(this,void 0,void 0,function(){var n,o=this;return v(this,function(r){return(n=this.readToken())?[2,this.apiService.patchSession(n.token,t).then(function(t){var r=e.fromToken(t);return r.sessionId!==n.sessionId&&(console.log("New session ID. Updating."),o.writeToken(r.token)),{session:r.token}})]:[2,this.apiService.postSession(t).then(function(e){return o.writeToken(e),{session:e}})]})})},t.prototype.removeAttributes=function(t){return w(this,void 0,void 0,function(){var n,o=this;return v(this,function(r){if(!(n=this.readToken()))throw new Error("Need existing session");return[2,this.apiService.patchSession(n.token,{},t).then(function(t){return w(o,void 0,void 0,function(){return v(this,function(o){switch(o.label){case 0:return e.fromToken(t).sessionId===n.sessionId?[3,2]:[4,this.writeToken(t)];case 1:o.sent(),o.label=2;case 2:return[2,{session:t}]}})})})]})})},t}();(p=window).__dmgCrossDomain=p.__dmgCrossDomain=p.__dmgCrossDomain||(f=S.getInstance(),{configure:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return f.configure.apply(f,e)},addAttributes:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return f.addAttributes.apply(f,e)},removeAttributes:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return f.removeAttributes.apply(f,e)},getSession:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return f.getSession.apply(f,e)},get isConfigured(){return f.isConfigured}})})();